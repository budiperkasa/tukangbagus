var BT=BT||{};
(function(){
    BT.Slideshow=new Class({
        Implements:[Options,Events],
        options:{},
        initialize:function(b){
            this.setOptions(b);
            var a=JSON.decode(new BT.Base64().base64Decode(this.options.encodedItems));
            var c=this;
            this.sortables=new Sortables(this.options.galleryContainer,{
                clone:true,
                revert:true,
                opacity:0.3,
                onStart:function(e,f){
                    f.setStyle("z-index",999)
                }
            });
            if(a!=null){
                a.each(function(e){
                    c.add(e)
                })
            }
            var d=null;
            if(typeof document.adminForm.onsubmit=="function"){
                d=document.adminForm.onsubmit
            }
            document.adminForm.onsubmit=function(){
                var e=[];
                var f=0;
                $$("#btss-gallery-container li").each(function(g){
                    var h=g.retrieve("item");
                    if(h!=null){
                        e[f]=h;
                        f++
                    }
                });
                $("btss-gallery-hidden").set("value",new BT.Base64().base64Encode(JSON.encode(e)));
                
                if(d!=null){
                    d()
                }
                
            }
        },
        add:function(d, tmp){
            var b=new Element("li",{
                html:'<img src="'+this.options.liveUrl+"modules/mod_btslideshow_pro/images/"+ (tmp ? "tmp/" : "") +"manager/"+d.file+'" /><a href="javascript:void(0)" class="edit">Edit</a><a href="javascript:void(0)" class="remove">Remove</a>'
            });
            var c=this;
            b.getElement(".edit").addEvent("click",function(){
                c.edit(b)
            });
            b.getElement(".remove").addEvent("click",function(){
                c.remove(b)
            });
            b.store("item",d);
            var a=$(this.options.galleryContainer);
            b.set("opacity",0);
            a.grab(b);
            b.fade("in");
            this.sortables.addItems(b)
        },
        edit:function(b){
            var a=new Element("div#btss-dialog",{
                html:this.options.dialogTemplate
            });
            var c=b.retrieve("item");
            a.getElement("#btss-title").set("value",c.title);
            a.getElement("#btss-link").set("value",c.link);
            a.getElement("#btss-target").set("value", c.target);
            a.getElement("#btss-desc").set("value",c.desc);
            a.getElement(".btss-dialog-ok").addEvent("click",function(){
                c.title=a.getElement("#btss-title").get("value");
                c.link=a.getElement("#btss-link").get("value");
                c.target = a.getElement("#btss-target").get("value");
                c.desc=a.getElement("#btss-desc").get("value");
                b.store("item",c);
                SqueezeBox.close()
            });
            a.getElement(".btss-dialog-cancel").addEvent("click",function(){
                SqueezeBox.close()
            });
            SqueezeBox.open(a,{
                handler:"adopt",
                size:{
                    x:800,
                    y:280
                }
            })
        },
        remove:function(a){
            
            var img = a.getElement('img').src;
            var c = this;
            jQuery.ajax({
                url: location.href,
                data: "action=delete&file="+img,
                type: "post",
                success: function(responseJSON){
                    var data = jQuery.parseJSON(responseJSON);
                    var files = jQuery.parseJSON(data.files);
                    if (!data.success) {
                        c.showMessage("btss-message", "<b>Delete image failed</b> - " + data.message);
                    }
                    else {
                        var b=new Fx.Morph(a);
                        b.start({
                            width:0,
                            height:0,
                            opacity:0
                        }).chain(function(){
                            a.dispose()
                        });
                        c.showMessage("btss-message", "<b>Delete images successful</b>");
                    }
                },
                complete: function(){
                    c.removeLog();
                },
                error: function(jqXHR, textStatus, errorThrown){
                    c.showMessage("btss-message", "Sending ajax request is failed. Check <b>ajax.php</b>, please.");
                    c.removeLog();
                }
        
            })
        },
        removeAll: function(){
           
            var a = $("btss-gallery-container");
            var b = a.getElements("li");
            var c = this;
            var success = true;
            b.each(function(d){
               var img = d.getElement('img').src;
                jQuery.ajax({
                    url: location.href,
                    data: "action=delete&id="+ c.options.moduleID + "&file="+ img,
                    type: "post",
                    success: function(responseJSON){
                        var data = jQuery.parseJSON(responseJSON);
                        var files = jQuery.parseJSON(data.files);
                        if (!data.success) {
                            success = false;
                        }
                        else {
                            var f=new Fx.Morph(d);
                            f.start({
                                width:0,
                                height:0,
                                opacity:0
                            }).chain(function(){
                                d.dispose()
                            });
                            success = true;
                        }
                    },
                    complete: function(){
                        c.removeLog();
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        c.showMessage("btss-message", "Sending ajax request is failed. Check <b>ajax.php</b>, please.");
                        c.removeLog();
                    }
        
                })
               
            });
            if(!success){
                c.showMessage("btss-message", "<b>Delete image failed</b> - " + data.message);
            }else{
                c.showMessage("btss-message", "<b>Delete images successful</b>");
            }
            c.removeLog();

            
        },
        showMessage:function(a,d){
            var a=$(a);
            var c=new Element("div.bt-message");
            c.set("html",d);
            c.set("opacity",0);
            a.grab(c,"top");
            var b=new Fx.Morph(c,{
                link:"chain"
            });
            b.start({
                opacity: 1, 
                visibility: 'visible'
            })
        },
        removeLog:function(){
            $("btss-message").getElements("div.bt-message").each(function(d,b,c){
                setTimeout(function(){
                    var e=new Fx.Morph(d,{
                        link:"chain"
                    });
                    e.start({
                        height:0,
                        opacity:0
                    }).chain(function(){
                        d.dispose()
                    })
                },1000)
            })
        }
    })
})();